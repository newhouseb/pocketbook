<html>
<head>
<meta charset='utf-8'>
<title>Pocketbook</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.6/showdown.min.js"></script>
<script>
function save() {
  alert(document.body.innerHTML);
}
function fork() {
  // Replace the unique ID

}
function autosave() {

}
function publish() {

}
</script>
<style>
.medium-style #center {
  margin-left: auto;
  margin-right: auto;
  width: 700px;
}

.medium-style h1 {
  font-family: helvetica, arial;
  font-size: 42px;
}

.medium-style p {
  font-size: 21px;
}

.medium-style .block {
  padding-top: 20px;
  margin-bottom: 10px;
  padding-left: 10px;
  border-left: 2px solid white;
}

.medium-style .focused {
  border-left: 2px solid black;
}

.medium-style pre {
  background-color: #f3f3f3;
  padding: 5px;
}

#center {
  position: relative;
}

#controls {
  position: absolute;
  left: 12px;
  top: 0px;
  height: 20px;
}
</style>
</head>
<body id="notebook1" class="medium-style">
<button onclick="save()">Save</button>
<button onclick="save()">Show/Hide Console</button>
<div id="center">
  <div id="controls">
    <button onclick="run()">Run</button>
    <button onclick="addAbove()">addAbove</button>
    <button onclick="addBelow()">addBelow</button>
    <button onclick="remove()">remove</button>
    <select onchange="chooseLanguage(event)" id="activelang">
      <option value="md">Markdown</option>
      <option value="js">Javascript</option>
      <option value="cljs">ClojureScript</option>
    </select>
    <select onchange="chooseVisibility(event)" id="visibility">
      <option value="source">Display Source</option>
      <option value="output">Display Output</option>
      <option value="both">Display Both</option>
      <option value="none">Display None</option>
    </select>
    <select onchange="chooseAutorun()" id="autorun">
      <option value="true">Run On-Demand</option>
      <option value="false">Run On-Load</option>
    </select>
  </div>

  <div data-lang="md" data-visibility="output" data-autorun="false" class="block focused">
    <pre contenteditable="true">
# Hello World

Here is some exposition</pre>
    <div>
      <h1>Hello World</h1>
      <p>Here is some exposition</p>
    </div>
  </div>

  <div data-lang="js" data-visibility="source" data-autorun="false" class="block focused">
    <pre class="source" contenteditable="true"><code>
console.log("Hello World");

bar = {
  _count: 1,
  set count(value) {
    this._count = value;
    this.render();
  },
  get count() {
    return this._count;
  },
  render: function() {
    return this.count;
  }
}</code></pre>
    <div class="output">
    Output
    </div>
  </div>
  <div id="next-block" class="block">
    <button>Add Block</button>
  </div>
</div>
</body>

<script>
var converter = new showdown.Converter();
var languages = {
  md: function(src) {
    return converter.makeHtml(src);
  },
  js: function(src) {
    var result = eval(src);
    // TODO: Wrap render to spit into the same element
    if (result.render) return result.render();
    return result;
  },
  cljs: function(src) {
    // For some reason I can't get the cljs.user namespace to autocreate (when not usign replumb)
    // cljs.user = cljs.user || {};
    // return cljs_eval.core.cljs_evaluate("(do " + src + ")", function(r) { window.result = r["arr"][7]; });
    return new Promise(function(resolve, reject) {
      replumb.core.read_eval_call(repl_options, 
      function(r) { 
        resolve(r.arr[7])
      }, "(do " + src + ")")
    });
  }
};

// macros.core$macros=> (ns macros.core$macros) (defmacro hello [x] (prn &form) `(inc ~x))
// macros.core$macros=> (macros.core/hello 1)

function updateVisibility(block) {
  // Could do this with CSS but don't want to fiddle with className splicing rn
  var src = block.children[0];
  var output = block.children[1];
  if (block.dataset.visibility == 'none') { src.style.display = 'none'; output.style.display = 'none'; }
  if (block.dataset.visibility == 'source') { src.style.display = ''; output.style.display = 'none'; }
  if (block.dataset.visibility == 'output') { src.style.display = 'none'; output.style.display = ''; }
  if (block.dataset.visibility == 'both') { src.style.display = ''; output.style.display = ''; }
}

function initBlock(block) {
  updateVisibility(block);
  block.addEventListener('mouseover', function(event) {
        // TODO: Move Focus
        document.getElementsByClassName('focused')[0].className = 'block';
        block.className = 'block focused';
        document.getElementById('controls').style.top = block.offsetTop + "px";

        document.getElementById('visibility').value = block.dataset.visibility;
        document.getElementById('activelang').value = block.dataset.lang;
        document.getElementById('autorun').value = block.dataset.autorun;
  });
}

// Add the right event listeners to shift focus around as you move
function init() {
  var blocks = document.getElementsByClassName("block");
  for (var i = 0; i < blocks.length; i++) {
    initBlock(blocks[i]);
  }
}

// Execute the currently selected block
function run() {
  var console = {
    log: function(e) { 
      alert(e); 
    }
  };
  var block = document.getElementsByClassName('focused')[0];
  Promise.resolve(languages[block.dataset.lang](block.children[0].innerText)).then(function(result) {
    block.children[1].innerHTML = result;
  });
}

function chooseVisibility(event) {
  var block = document.getElementsByClassName('focused')[0];
  block.dataset.visibility = event.target.value;
  updateVisibility(block);
}

function chooseLanguage(event) {
  var block = document.getElementsByClassName('focused')[0];
  block.dataset.lang = event.target.value;
  updateVisibility(block);
}

// Load any saved, more up to date, copies of this notebook
// Note: Need Disable Local File Restructions in the Developer Menu in Safari for this to work
var savedCopy = window.localStorage.getItem(document.body.id);
if (savedCopy && savedCopy != document.body.innerHTML) {
  document.body.innerHTML = savedCopy;
  init();
} 

// Periodically persist the current notebook to localstorage
function autosave() {
  console.log("Autosaving");
  window.localStorage.setItem(document.body.id, document.body.innerHTML);
  setTimeout(autosave, 1000);
}
autosave();

//Insert a new block below the current cell
function addBelow() {
  var block = document.createElement("div");
  block.dataset.lang = "md";
  block.dataset.visibility = "both";
  block.dataset.autorun = "false";
  block.className = "block";

  var source = document.createElement("pre");
  source.contentEditable = "true";

  var output = document.createElement("div");

  block.appendChild(source);
  block.appendChild(output);

  document.getElementById('center').appendChild(block);
}

</script>

<!-- <script src="https://s3.amazonaws.com/bencubator.com/lib/cljs_eval.js"></script> -->
<!-- <script src="http://localhost:8000/out/main.js"></script>-->
<script src="http://clojurescript.io/main.js"></script>
<script>
// Seeing if this is somehow persistent...
var repl_options = replumb.core.options(replumb.repl.read_string(null, ":browser"), []);
</script>

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>
  var blocks = document.getElementsByClassName("source");
  for (var i = 0; i < blocks.length; i++) {
    hljs.highlightBlock(blocks[i]);
  }
</script>

<!--
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>-->

</html>
